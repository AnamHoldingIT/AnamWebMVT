{% extends "admin-panel/base_admin.html" %}
{% load static %}

{% block title %}مدیریت پورتفوی | پروژه‌ها{% endblock %}
{% block menu_portfolio %}active{% endblock %}

{% block content %}

<div class="topbar mb-4">
  <div>
    <h2 class="mb-1">پروژه‌های پورتفوی</h2>
    <div class="text-muted" style="font-size:.85rem;">
      مدیریت پروژه‌ها + متریک‌ها، هایلایت‌ها، مراحل و نقش‌ها (از داخل دیتیل هر پروژه)
    </div>
  </div>

  <div class="d-flex gap-2 flex-wrap">
    <a href="{% url 'admin_panel:portfolio_project_create' %}" class="btn btn-sm btn-warning">
      <i class="bi bi-plus-circle ms-1"></i>
      پروژه جدید
    </a>

    <a href="{% url 'admin_panel:portfolio_categories' %}" class="btn btn-sm btn-outline-light">
      <i class="bi bi-tags ms-1"></i>
      دسته‌بندی‌ها
    </a>

    <a href="{% url 'admin_panel:portfolio_roles' %}" class="btn btn-sm btn-outline-light">
      <i class="bi bi-person-badge ms-1"></i>
      نقش‌ها
    </a>
  </div>
</div>

<div class="panel-box">

  <div class="panel-header mb-3">
    <h6 class="box-title mb-0">فیلتر و جستجو</h6>
    <span class="panel-badge">{{ page_obj.paginator.count|default:0 }} مورد</span>
  </div>

  <form method="get" class="row g-2 align-items-end">

    <!-- Search -->
    <div class="col-12 col-lg-4">
      <label class="detail-label">جستجو</label>
      <div class="search-box w-100">
        <i class="bi bi-search"></i>
        <input type="text" name="q" value="{{ q }}" placeholder="نام فارسی/انگلیسی، اسلاگ، تگ‌لاین..." />
      </div>
    </div>

    <!-- Status -->
    <div class="col-12 col-md-4 col-lg-2">
      <label class="detail-label">وضعیت</label>
      <select class="form-select bg-green" name="status">
        <option value="">همه</option>
        {% for v, t in status_choices %}
          <option value="{{ v }}" {% if current_status == v %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Category -->
    <div class="col-12 col-md-4 col-lg-3">
      <label class="detail-label">دسته‌بندی</label>
      <select class="form-select bg-green" name="category">
        <option value="">همه</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if current_category|stringformat:"s" == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Featured -->
    <div class="col-12 col-md-4 col-lg-2">
      <label class="detail-label">نمایش در خانه</label>
      <select class="form-select bg-green" name="featured">
        <option value="">همه</option>
        <option value="1" {% if current_featured == "1" %}selected{% endif %}>فقط Featured</option>
        <option value="0" {% if current_featured == "0" %}selected{% endif %}>فقط غیر Featured</option>
      </select>
    </div>

    <!-- Actions -->
    <div class="col-12 col-md-4 col-lg-1 d-grid">
      <button class="btn btn-sm btn-light">
        اعمال
      </button>
    </div>

    {% if q or current_status or current_category or current_featured %}
    <div class="col-12">
      <a class="detail-back-btn" href="{% url 'admin_panel:portfolio_projects' %}">
        <i class="bi bi-x-circle"></i>
        پاک کردن فیلترها
      </a>
    </div>
    {% endif %}
  </form>

</div>

<div class="panel-box mt-3">
  <div class="panel-header mb-2">
    <h6 class="box-title mb-0">لیست پروژه‌ها</h6>
    <span class="panel-badge">صفحه {{ page_obj.number|default:1 }} از {{ page_obj.paginator.num_pages|default:1 }}</span>
  </div>

  <div class="table-responsive">
    <table class="table table-dark table-borderless align-middle mb-0" style="--bs-table-bg: transparent;">
      <thead style="color: #cfdad7;">
        <tr>
          <th style="width:70px;">تصویر</th>
          <th>پروژه</th>
          <th style="width:150px;">دسته‌بندی</th>
          <th style="width:120px;">وضعیت</th>
          <th class="text-center" style="width:80px;">H</th>
          <th class="text-center" style="width:80px;">M</th>
          <th class="text-center" style="width:80px;">S</th>
          <th class="text-center" style="width:80px;">R</th>
          <th style="width:190px;">عملیات</th>
        </tr>
      </thead>

      <tbody>
        {% for p in projects %}
          <tr style="border-top: 1px solid rgba(255,255,255,0.06);">
            <td>
              <div style="width:52px;height:38px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.35);">
                {% if p.image %}
                  <img src="{{ p.image.url }}" alt="{{ p.name_fa }}" style="width:100%;height:100%;object-fit:cover;">
                {% else %}
                  <div class="d-flex align-items-center justify-content-center h-100" style="font-size:.75rem;color:#90a7a5;">
                    —
                  </div>
                {% endif %}
              </div>
            </td>

            <td>
              <div class="d-flex flex-column gap-1">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                  <a class="text-decoration-none" href="{% url 'admin_panel:portfolio_project_detail' p.slug %}" style="color:#f1f1f1;font-weight:700;">
                    {{ p.name_fa }}
                  </a>

                  {% if p.is_featured_home %}
                    <span class="detail-badge detail-badge-success">
                      <i class="bi bi-star-fill"></i> Featured
                    </span>
                  {% endif %}
                </div>

                <div style="font-size:.82rem;color:#90a7a5;">
                  <span class="dir-ltr">/{{ p.slug }}/</span>
                  {% if p.name_en %} • <span class="dir-ltr">{{ p.name_en }}</span>{% endif %}
                </div>

                {% if p.short_tagline %}
                  <div style="font-size:.83rem;color:#d0dcda;opacity:.95;">
                    {{ p.short_tagline|truncatechars:90 }}
                  </div>
                {% endif %}
              </div>
            </td>

            <td>
              {% if p.category %}
                <span class="activity-tag">
                  {% if p.category.icon_class %}<i class="bi {{ p.category.icon_class }} ms-1"></i>{% endif %}
                  {{ p.category.name }}
                </span>
              {% else %}
                <span class="activity-tag">—</span>
              {% endif %}
            </td>

            <td>
              {% if p.status == "active" %}
                <span class="detail-badge detail-badge-success"><i class="bi bi-check2-circle"></i> فعال</span>
              {% elif p.status == "paused" %}
                <span class="detail-badge detail-badge-warning"><i class="bi bi-pause-circle"></i> متوقف</span>
              {% elif p.status == "exited" %}
                <span class="detail-badge detail-badge-info"><i class="bi bi-box-arrow-up-right"></i> خروج</span>
              {% else %}
                <span class="detail-badge"><i class="bi bi-dot"></i> {{ p.get_status_display }}</span>
              {% endif %}
            </td>

            <!-- Counts -->
            <td class="text-center">
              <span class="panel-badge">{{ p.highlights_count|default:0 }}</span>
            </td>
            <td class="text-center">
              <span class="panel-badge">{{ p.metrics_count|default:0 }}</span>
            </td>
            <td class="text-center">
              <span class="panel-badge">{{ p.steps_count|default:0 }}</span>
            </td>
            <td class="text-center">
              <span class="panel-badge">{{ p.roles_count|default:0 }}</span>
            </td>

            <td>
              <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'admin_panel:portfolio_project_detail' p.slug %}" class="btn btn-sm btn-outline-light">
                  <i class="bi bi-eye ms-1"></i> جزئیات
                </a>
                <a href="{% url 'admin_panel:portfolio_project_edit' p.slug %}" class="btn btn-sm btn-outline-warning">
                  <i class="bi bi-pencil-square ms-1"></i> ویرایش
                </a>
                <a href="{% url 'admin_panel:portfolio_project_delete' p.slug %}" class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-trash3 ms-1"></i> حذف
                </a>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="9">
              <div class="text-center py-4" style="color:#90a7a5;">
                موردی یافت نشد.
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if is_paginated %}
    <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
      <div style="font-size:.82rem;color:#90a7a5;">
        نمایش {{ page_obj.start_index }} تا {{ page_obj.end_index }} از {{ page_obj.paginator.count }}
      </div>

      <nav aria-label="pagination">
        <ul class="pagination pagination-sm mb-0">

          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&status={{ current_status }}&category={{ current_category }}&featured={{ current_featured }}">قبلی</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">قبلی</span></li>
          {% endif %}

          <li class="page-item disabled">
            <span class="page-link">
              {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
            </span>
          </li>

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&status={{ current_status }}&category={{ current_category }}&featured={{ current_featured }}">بعدی</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">بعدی</span></li>
          {% endif %}

        </ul>
      </nav>
    </div>
  {% endif %}

  <div class="mt-3" style="font-size:.78rem;color:#90a7a5;">
    <span class="panel-badge me-1">H</span> هایلایت‌ها
    <span class="panel-badge mx-1">M</span> متریک‌ها
    <span class="panel-badge mx-1">S</span> مراحل مسیر
    <span class="panel-badge mx-1">R</span> نقش‌ها
  </div>

</div>

{% endblock %}
